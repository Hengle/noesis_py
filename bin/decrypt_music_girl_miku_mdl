#!/usr/bin/env python

import sys
import os

KEY = bytearray([0x44,0x90,0x12,0x28])

def xor(data, key):
    return bytearray(((data[i] ^ key[i % len(key)]) for i in range(0,len(data))))

def decrypt(path):
    basenameWithoutExtension = os.path.splitext(path)[0]
    output = basenameWithoutExtension + "_decrypted.mdl"
    encryptedData = bytearray(open(path).read())
    decryptedData = xor(encryptedData, KEY)
    decryptedData = decryptedData[16:]
    open(output, 'wb').write(decryptedData)

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print 'usage: decrypt_music_girl_miku_mdl model_file'
        return

    decrypt(sys.argv[1])
